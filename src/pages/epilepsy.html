<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kifafa - Epilepsy Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        /* EMERGENCY BUTTON */
        .emergency-btn {
            width: 100%;
            background: #d32f2f;
            color: white;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .emergency-btn:hover {
            background: #b71c1c;
        }
        
        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .tab-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        /* CONTENT AREAS */
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* SEIZURE FORM (Hidden by default) */
        .seizure-form {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .seizure-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .checkbox-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-secondary {
            background: #757575;
            color: white;
            margin-left: 10px;
        }
        
        .btn-danger {
            background: #d32f2f;
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        /* SEIZURE LIST */
        .seizure-list {
            list-style: none;
        }
        
        .seizure-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
            position: relative;
        }
        
        .seizure-date {
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 5px;
        }
        
        .seizure-details {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        /* BASIC THERAPY SECTION */
        .therapy-section {
            margin-bottom: 30px;
        }
        
        .therapy-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
        }
        
        .medication-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
            position: relative;
        }
        
        .med-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .med-details {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }
        
        .development-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #FF9800;
        }
        
        .dev-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .dev-row:last-child {
            border-bottom: none;
        }
        
        .dev-label {
            font-weight: bold;
            color: #555;
        }
        
        .dev-value {
            color: #333;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        /* MODAL for medication form */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>

    <!-- EMERGENCY BUTTON -->
    <button class="emergency-btn" onclick="openSeizureForm()">
        üö® DEGEDEGE IMEANZA
    </button>

    <!-- SEIZURE FORM (Hidden by default) -->
    <div class="seizure-form" id="seizureForm">
        <h2>Rekodi Mshtuko wa Kifafa</h2>
        
        <form id="seizureEntryForm">
            <div class="form-group">
                <label>Tarehe na Saa:</label>
                <input type="datetime-local" id="seizureDateTime" required>
            </div>
            
            <div class="form-group">
                <label>Muda wa kudumu:</label>
                <input type="text" id="seizureDuration" placeholder="Mfano: 2 dakika, 30 sekunde" required>
            </div>
            
            <div class="form-group">
                <label>Alifanya nini kabla ya mshtuko?</label>
                <textarea id="beforeSeizure" placeholder="Alikuwa usingizini, akicheza, n.k."></textarea>
            </div>
            
            <div class="form-group">
                <label>Aura - Aliona/kusikia kitu kabla?</label>
                <textarea id="aura" placeholder="Machozi, kulia, n.k."></textarea>
            </div>
            
            <div class="form-group">
                <label>Jinsi alivyoanza:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="onset" value="kulia"> Kulia</label>
                    <label><input type="checkbox" name="onset" value="kuangalia_upande"> Kuangalia upande</label>
                    <label><input type="checkbox" name="onset" value="machozi"> Machozi</label>
                    <label><input type="checkbox" name="onset" value="mengine"> Mengine</label>
                </div>
                <input type="text" id="onsetOther" placeholder="Eleza zaidi..." style="margin-top: 8px;">
            </div>
            
            <div class="form-group">
                <label>Mwili ulivyotikisika:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="bodyParts" value="mikono"> Mikono</label>
                    <label><input type="checkbox" name="bodyParts" value="miguu"> Miguu</label>
                    <label><input type="checkbox" name="bodyParts" value="uso"> Uso/Macho</label>
                    <label><input type="checkbox" name="bodyParts" value="mwili_wote"> Mwili wote</label>
                    <label><input type="checkbox" name="bodyParts" value="upande_mmoja"> Upande mmoja tu (Kulia/Kushoto)</label>
                </div>
                <input type="text" id="bodyPartsDetails" placeholder="Eleza zaidi..." style="margin-top: 8px;">
            </div>
            
            <div class="form-group">
                <label>Ameoteza ufahamu?</label>
                <select id="lostConsciousness">
                    <option value="">Chagua...</option>
                    <option value="ndiyo_kabisa">Ndiyo kabisa</option>
                    <option value="kidogo">Kidogo</option>
                    <option value="hapana">Hapana</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Triggers (Sababu zinazoweza kusababisha):</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="triggers" value="homa"> Homa/Joto la mwili</label>
                    <label><input type="checkbox" name="triggers" value="usingizi"> Hakupata usingizi wa kutosha</label>
                    <label><input type="checkbox" name="triggers" value="dawa"> Amesahau dawa</label>
                    <label><input type="checkbox" name="triggers" value="stress"> Stress/Trauma</label>
                    <label><input type="checkbox" name="triggers" value="mwanga"> Mwanga mkali</label>
                </div>
                <input type="text" id="triggersOther" placeholder="Triggers zingine..." style="margin-top: 8px;">
            </div>
            
            <div class="form-group">
                <label>Baada ya mshtuko:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="afterSeizure" value="alisinzia"> Alisinzia</label>
                    <label><input type="checkbox" name="afterSeizure" value="alichoka"> Alichoka sana</label>
                    <label><input type="checkbox" name="afterSeizure" value="confused"> Alichanganyikiwa</label>
                    <label><input type="checkbox" name="afterSeizure" value="headache"> Maumivu ya kichwa</label>
                </div>
                <textarea id="afterSeizureDetails" placeholder="Eleza zaidi..." style="margin-top: 8px;"></textarea>
            </div>
            
            <div class="form-group">
                <label>Dawa ya dharura imetumika?</label>
                <input type="text" id="emergencyMeds" placeholder="Mfano: Diazepam 5mg rectal">
            </div>
            
            <div class="form-group">
                <label>Imeisha hospitali au nyumbani?</label>
                <select id="location">
                    <option value="nyumbani">Nyumbani</option>
                    <option value="hospitali">Hospitali</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Je, leo ametumia dawa zake za kawaida?</label>
                <select id="tookMeds">
                    <option value="ndiyo">Ndiyo</option>
                    <option value="hapana">Hapana</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Video/Picha (optional):</label>
                <input type="file" id="videoUpload" accept="video/*,image/*">
            </div>
            
            <div class="form-group">
                <label>Maelezo mengine:</label>
                <textarea id="additionalNotes" placeholder="Taarifa nyingine muhimu..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">Hifadhi</button>
            <button type="button" class="btn btn-secondary" onclick="closeSeizureForm()">Ghairi</button>
        </form>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('basicInfo')">Taarifa za Msingi</button>
        <button class="tab-btn" onclick="showTab('history')">Historia ya Seizures</button>
    </div>

    <!-- TAB CONTENT: BASIC INFO -->
    <div class="tab-content active" id="basicInfo">
        <div class="therapy-section">
            <h3>Dawa za Kawaida (Basic Therapy)</h3>
            <div id="medicationList">
                <div class="loading">Inapakia...</div>
            </div>
            <button class="btn btn-primary" onclick="openMedicationModal()">+ Ongeza Dawa</button>
        </div>
        
        <div class="therapy-section">
            <h3>Uwezo wa Mtoto (Development)</h3>
            <div id="developmentInfo">
                <div class="loading">Inapakia...</div>
            </div>
            <button class="btn btn-primary" onclick="openDevelopmentModal()">Rekodi Uwezo</button>
        </div>
    </div>

    <!-- TAB CONTENT: HISTORY -->
    <div class="tab-content" id="history">
        <h3>Historia ya Mishtuko</h3>
        <button class="btn btn-primary" onclick="generateReport()" style="margin-bottom: 20px;">üìÑ Toa Ripoti kwa Daktari</button>
        
        <ul class="seizure-list" id="seizureList">
            <div class="loading">Inapakia...</div>
        </ul>
    </div>

    <!-- MEDICATION MODAL -->
    <div class="modal" id="medicationModal">
        <div class="modal-content">
            <div class="modal-header">Ongeza Dawa Mpya</div>
            <form id="medicationForm">
                <div class="form-group">
                    <label>Jina la Dawa:</label>
                    <input type="text" id="medName" required>
                </div>
                
                <div class="form-group">
                    <label>Uzito wa Mtoto (kg):</label>
                    <input type="number" id="childWeight" step="0.1">
                </div>
                
                <div class="form-group">
                    <label>Asubuhi:</label>
                    <input type="text" id="dosageAsubuhi" placeholder="Mfano: 150mg">
                </div>
                
                <div class="form-group">
                    <label>Mchana:</label>
                    <input type="text" id="dosageMchana" placeholder="Mfano: 150mg">
                </div>
                
                <div class="form-group">
                    <label>Jioni:</label>
                    <input type="text" id="dosageJioni" placeholder="Mfano: 150mg">
                </div>
                
                <div class="form-group">
                    <label>Usiku:</label>
                    <input type="text" id="dosageUsiku" placeholder="Mfano: 30mg">
                </div>
                
                <div class="form-group">
                    <label>Picha ya Dawa (optional):</label>
                    <input type="file" id="medPhoto" accept="image/*">
                </div>
                
                <button type="submit" class="btn btn-primary">Hifadhi</button>
                <button type="button" class="btn btn-secondary" onclick="closeMedicationModal()">Ghairi</button>
            </form>
        </div>
    </div>

    <!-- DEVELOPMENT MODAL -->
    <div class="modal" id="developmentModal">
        <div class="modal-content">
            <div class="modal-header">Rekodi Uwezo wa Mtoto</div>
            <form id="developmentForm">
                <div class="form-group">
                    <label>Anaongea vizuri?</label>
                    <select id="devSpeech" required>
                        <option value="">Chagua...</option>
                        <option value="ndiyo">Ndiyo</option>
                        <option value="hapana">Hapana</option>
                        <option value="kidogo">Kidogo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Anacheza na watoto wengine?</label>
                    <select id="devSocial" required>
                        <option value="">Chagua...</option>
                        <option value="ndiyo">Ndiyo</option>
                        <option value="hapana">Hapana</option>
                        <option value="kidogo">Kidogo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Anawafahamu wazazi?</label>
                    <select id="devRecognize" required>
                        <option value="">Chagua...</option>
                        <option value="ndiyo">Ndiyo</option>
                        <option value="hapana">Hapana</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Shule - Anafanya vipi?</label>
                    <textarea id="devSchool" placeholder="Eleza jinsi anavyofanya shuleni..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Kukojoa/Kinyesi - Ana control?</label>
                    <select id="devControl" required>
                        <option value="">Chagua...</option>
                        <option value="ndiyo">Ndiyo</option>
                        <option value="hapana">Hapana</option>
                        <option value="kidogo">Mara nyingine</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Maelezo mengine:</label>
                    <textarea id="devNotes" placeholder="Taarifa nyingine..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">Hifadhi</button>
                <button type="button" class="btn btn-secondary" onclick="closeDevelopmentModal()">Ghairi</button>
            </form>
        </div>
    </div>

    <!-- INCLUDE EPILEPSY MANAGER -->
    <script src="../js/core/epilepsy-manager.js"></script>
    
    <script>
        // Initialize on page load
        let manager;
        
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                manager = new EpilepsyManager();
                await manager.init();
                console.log('Database initialized successfully');
                
                // Load all data
                await loadMedications();
                await loadDevelopment();
                await loadSeizures();
            } catch (error) {
                console.error('Error initializing database:', error);
                alert('Kuna tatizo la kuanzisha database. Tafadhali reload page.');
            }
        });
        
        // ============ TAB SWITCHING ============
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // ============ SEIZURE FORM ============
        function openSeizureForm() {
            document.getElementById('seizureForm').classList.add('active');
            const now = new Date();
            const datetime = now.toISOString().slice(0, 16);
            document.getElementById('seizureDateTime').value = datetime;
            window.scrollTo(0, 0);
        }
        
        function closeSeizureForm() {
            document.getElementById('seizureForm').classList.remove('active');
            document.getElementById('seizureEntryForm').reset();
        }
        
        // Handle seizure form submission
        document.getElementById('seizureEntryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Collect checkbox values
                const onsetChecks = Array.from(document.querySelectorAll('input[name="onset"]:checked'))
                    .map(cb => cb.value);
                const bodyPartsChecks = Array.from(document.querySelectorAll('input[name="bodyParts"]:checked'))
                    .map(cb => cb.value);
                const triggersChecks = Array.from(document.querySelectorAll('input[name="triggers"]:checked'))
                    .map(cb => cb.value);
                const afterSeizureChecks = Array.from(document.querySelectorAll('input[name="afterSeizure"]:checked'))
                    .map(cb => cb.value);
                
                // Handle video file
                const videoFile = document.getElementById('videoUpload').files[0];
                let videoData = null;
                if (videoFile) {
                    videoData = await fileToBase64(videoFile);
                }
                
                const seizureData = {
                    dateTime: document.getElementById('seizureDateTime').value,
                    duration: document.getElementById('seizureDuration').value,
                    beforeSeizure: document.getElementById('beforeSeizure').value,
                    aura: document.getElementById('aura').value,
                    onset: onsetChecks,
                    onsetOther: document.getElementById('onsetOther').value,
                    bodyParts: bodyPartsChecks,
                    bodyPartsDetails: document.getElementById('bodyPartsDetails').value,
                    lostConsciousness: document.getElementById('lostConsciousness').value,
                    triggers: triggersChecks,
                    triggersOther: document.getElementById('triggersOther').value,
                    afterSeizure: afterSeizureChecks,
                    afterSeizureDetails: document.getElementById('afterSeizureDetails').value,
                    emergencyMeds: document.getElementById('emergencyMeds').value,
                    location: document.getElementById('location').value,
                    tookMeds: document.getElementById('tookMeds').value,
                    video: videoData,
                    additionalNotes: document.getElementById('additionalNotes').value
                };
                
                await manager.saveSeizure(seizureData);
                alert('‚úÖ Taarifa imehifadhiwa!');
                closeSeizureForm();
                await loadSeizures();
            } catch (error) {
                console.error('Error saving seizure:', error);
                alert('‚ùå Kuna tatizo la kuhifadhi taarifa. Jaribu tena.');
            }
        });
        
        // ============ LOAD SEIZURES ============
        async function loadSeizures() {
            try {
                const seizures = await manager.getAllSeizures();
                const listElement = document.getElementById('seizureList');
                
                if (seizures.length === 0) {
                    listElement.innerHTML = '<div class="empty-state">Hakuna taarifa za mishtuko bado</div>';
                    return;
                }
                
                listElement.innerHTML = seizures.map(seizure => {
                    const date = new Date(seizure.dateTime);
                    const formattedDate = date.toLocaleDateString('sw-TZ', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const formattedTime = date.toLocaleTimeString('sw-TZ', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <li class="seizure-item">
                            <button class="btn btn-danger delete-btn" onclick="deleteSeizure(${seizure.id})">üóëÔ∏è</button>
                            <div class="seizure-date">${formattedDate} - ${formattedTime}</div>
                            <div class="seizure-details">
                                <strong>Muda:</strong> ${seizure.duration}<br>
                                ${seizure.bodyParts.length > 0 ? `<strong>Mwili:</strong> ${seizure.bodyParts.join(', ')}<br>` : ''}
                                ${seizure.triggers.length > 0 ? `<strong>Triggers:</strong> ${seizure.triggers.join(', ')}<br>` : ''}
                                ${seizure.afterSeizure.length > 0 ? `<strong>Baada:</strong> ${seizure.afterSeizure.join(', ')}<br>` : ''}
                                ${seizure.emergencyMeds ? `<strong>Dawa ya dharura:</strong> ${seizure.emergencyMeds}<br>` : ''}
                                <strong>Dawa za kawaida:</strong> ${seizure.tookMeds === 'ndiyo' ? 'Ndiyo ‚úì' : 'Hapana ‚úó'}
                            </div>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading seizures:', error);
            }
        }
        
        async function deleteSeizure(id) {
            if (confirm('Una uhakika unataka kufuta taarifa hii?')) {
                try {
                    await manager.deleteSeizure(id);
                    await loadSeizures();
                    alert('‚úÖ Taarifa imefutwa!');
                } catch (error) {
                    console.error('Error deleting seizure:', error);
                    alert('‚ùå Kuna tatizo la kufuta taarifa.');
                }
            }
        }
        
        // ============ MEDICATION MODAL ============
        function openMedicationModal() {
            document.getElementById('medicationModal').classList.add('active');
        }
        
        function closeMedicationModal() {
            document.getElementById('medicationModal').classList.remove('active');
            document.getElementById('medicationForm').reset();
        }
        
        document.getElementById('medicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const photoFile = document.getElementById('medPhoto').files[0];
                let photoData = null;
                if (photoFile) {
                    photoData = await fileToBase64(photoFile);
                }
                
                const medData = {
                    medicationName: document.getElementById('medName').value,
                    childWeight: document.getElementById('childWeight').value,
                    timing: {
                        asubuhi: document.getElementById('dosageAsubuhi').value,
                        mchana: document.getElementById('dosageMchana').value,
                        jioni: document.getElementById('dosageJioni').value,
                        usiku: document.getElementById('dosageUsiku').value
                    },
                    photo: photoData
                };
                
                await manager.saveMedication(medData);
                alert('‚úÖ Dawa imehifadhiwa!');
                closeMedicationModal();
                await loadMedications();
            } catch (error) {
                console.error('Error saving medication:', error);
                alert('‚ùå Kuna tatizo la kuhifadhi dawa.');
            }
        });
        
        // ============ LOAD MEDICATIONS ============
        async function loadMedications() {
            try {
                const medications = await manager.getAllMedications();
                const listElement = document.getElementById('medicationList');
                
                if (medications.length === 0) {
                    listElement.innerHTML = '<div class="empty-state">Hakuna dawa zilizohifadhiwa bado</div>';
                    return;
                }
                
                listElement.innerHTML = medications.map(med => {
                    const timingText = Object.entries(med.timing)
                        .filter(([time, dose]) => dose)
                        .map(([time, dose]) => `${time}: ${dose}`)
                        .join(', ');
                    
                    return `
                        <div class="medication-item">
                            <button class="btn btn-danger delete-btn" onclick="deactivateMedication(${med.id})">üóëÔ∏è</button>
                            <div class="med-name">${med.medicationName}</div>
                            <div class="med-details">
                                ${med.childWeight ? `<strong>Uzito:</strong> ${med.childWeight}kg<br>` : ''}
                                <strong>Muda:</strong> ${timingText}<br>
                                <small>Imeongezwa: ${new Date(med.createdAt).toLocaleDateString('sw-TZ')}</small>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading medications:', error);
            }
        }
        
        async function deactivateMedication(id) {
            if (confirm('Una uhakika unataka kuondoa dawa hii?')) {
                try {
                    await manager.deactivateMedication(id, 'Imeondolwa na mtumiaji');
                    await loadMedications();
                    alert('‚úÖ Dawa imeondolewa!');
                } catch (error) {
                    console.error('Error deactivating medication:', error);
                    alert('‚ùå Kuna tatizo la kuondoa dawa.');
                }
            }
        }
        
        // ============ DEVELOPMENT MODAL ============
        function openDevelopmentModal() {
            document.getElementById('developmentModal').classList.add('active');
        }
        
        function closeDevelopmentModal() {
            document.getElementById('developmentModal').classList.remove('active');
            document.getElementById('developmentForm').reset();
        }
        
        document.getElementById('developmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const devData = {
                    speech: document.getElementById('devSpeech').value,
                    socialInteraction: document.getElementById('devSocial').value,
                    recognizesParents: document.getElementById('devRecognize').value,
                    schoolPerformance: document.getElementById('devSchool').value,
                    bladderControl: document.getElementById('devControl').value,
                    bowelControl: document.getElementById('devControl').value,
                    notes: document.getElementById('devNotes').value
                };
                
                await manager.saveDevelopment(devData);
                alert('‚úÖ Taarifa za uwezo zimehifadhiwa!');
                closeDevelopmentModal();
                await loadDevelopment();
            } catch (error) {
                console.error('Error saving development:', error);
                alert('‚ùå Kuna tatizo la kuhifadhi taarifa.');
            }
        });
        
        // ============ LOAD DEVELOPMENT ============
        async function loadDevelopment() {
            try {
                const dev = await manager.getLatestDevelopment();
                const element = document.getElementById('developmentInfo');
                
                if (!dev) {
                    element.innerHTML = '<div class="empty-state">Hakuna taarifa za uwezo bado</div>';
                    return;
                }
                
                const date = new Date(dev.recordDate).toLocaleDateString('sw-TZ');
                
                element.innerHTML = `
                    <div class="development-item">
                        <div class="dev-row">
                            <span class="dev-label">Anaongea vizuri?</span>
                            <span class="dev-value">${dev.speech}</span>
                        </div>
                        <div class="dev-row">
                            <span class="dev-label">Anacheza na watoto?</span>
                            <span class="dev-value">${dev.socialInteraction}</span>
                        </div>
                        <div class="dev-row">
                            <span class="dev-label">Anawafahamu wazazi?</span>
                            <span class="dev-value">${dev.recognizesParents}</span>
                        </div>
                        <div class="dev-row">
                            <span class="dev-label">Control ya kukojoa/kinyesi?</span>
                            <span class="dev-value">${dev.bladderControl}</span>
                        </div>
                        ${dev.schoolPerformance ? `
                        <div class="dev-row">
                            <span class="dev-label">Shule:</span>
                            <span class="dev-value">${dev.schoolPerformance}</span>
                        </div>
                        ` : ''}
                        <div style="margin-top: 10px; font-size: 12px; color: #999;">
                            Imerekodi: ${date}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading development:', error);
            }
        }
        
        // ============ REPORT GENERATION ============
        async function generateReport() {
            try {
                const report = await manager.generateReport();
                
                // Create simple text report
                let reportText = '=== RIPOTI YA KIFAFA ===\n\n';
                reportText += `Tarehe: ${new Date().toLocaleDateString('sw-TZ')}\n\n`;
                reportText += `--- MISHTUKO ---\n`;
                reportText += `Jumla: ${report.summary.totalSeizures}\n`;
                reportText += `Wastani kwa wiki: ${report.summary.averagePerWeek}\n\n`;
                
                if (report.summary.commonTriggers.length > 0) {
                    reportText += `Triggers za kawaida:\n`;
                    report.summary.commonTriggers.forEach(([trigger, count]) => {
                        reportText += `- ${trigger}: ${count} mara\n`;
                    });
                    reportText += '\n';
                }
                
                reportText += `--- DAWA ---\n`;
                report.medications.forEach(med => {
                    reportText += `${med.medicationName}\n`;
                    Object.entries(med.timing).forEach(([time, dose]) => {
                        if (dose) reportText += `  ${time}: ${dose}\n`;
                    });
                });
                
                // Download as text file
                const blob = new Blob([reportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ripoti-kifafa-${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
                
                alert('‚úÖ Ripoti imetengenezwa!');
            } catch (error) {
                console.error('Error generating report:', error);
                alert('‚ùå Kuna tatizo la kutengeneza ripoti.');
            }
        }
        
        // ============ UTILITY FUNCTIONS ============
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>

</body>
</html>
