<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mzio wa Chakula - Food Allergy Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Alert Banner */
        .exclusion-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .exclusion-banner.active {
            display: block;
        }

        .exclusion-banner.danger {
            background: #ffebee;
            border-color: #f44336;
        }

        .exclusion-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .danger .exclusion-title {
            color: #c62828;
        }

        .exclusion-list {
            list-style: none;
            padding-left: 20px;
        }

        .exclusion-item {
            padding: 5px 0;
        }

        .status-testing {
            color: #d32f2f;
            font-weight: bold;
        }

        .status-queue {
            color: #f57c00;
        }

        .status-waiting {
            color: #388e3c;
        }

        /* Testing Alert */
        .testing-alert {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        .testing-alert.active {
            display: block;
        }

        .testing-alert h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .checklist {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
        }

        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .testing-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-start-test {
            background: white;
            color: #4caf50;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }

        .btn-postpone {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 2px solid white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            flex: 1;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .child-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .child-selector select {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-size: 1rem;
        }

        .add-child-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .child-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
            font-size: 1.1rem;
        }

        .danger-tag {
            background: #ffebee;
            color: #c62828;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Testing Queue */
        .queue-container {
            margin-top: 20px;
        }

        .queue-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #e0e0e0;
        }

        .queue-item.testing {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .queue-item.waiting {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .queue-item.scheduled {
            border-left-color: #4caf50;
            background: #e8f5e8;
        }

        .queue-info {
            flex: 1;
        }

        .queue-food-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .queue-status {
            color: #666;
            font-size: 0.9rem;
        }

        .queue-date {
            font-weight: bold;
            color: #1976d2;
        }

        .queue-actions {
            display: flex;
            gap: 10px;
        }

        .queue-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Food diary remains same */
        .food-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .food-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .add-food-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }

        .foods-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            min-height: 50px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .food-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Test Instructions Modal */
        .test-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .test-modal.show {
            display: flex;
        }

        .test-modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .test-steps {
            margin: 20px 0;
        }

        .test-step {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
        }

        .test-step-time {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .reaction-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-reaction {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .btn-no-reaction {
            background: #4caf50;
            color: white;
        }

        .btn-had-reaction {
            background: #f44336;
            color: white;
        }

        /* Results display */
        .results-container {
            margin-top: 20px;
        }

        .result-card {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .result-safe {
            background: #e8f5e8;
            border: 2px solid #4caf50;
        }

        .result-allergen {
            background: #ffebee;
            border: 2px solid #f44336;
        }

        .result-dangerous {
            background: #212121;
            color: white;
            border: 2px solid #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Exclusion Banner -->
        <div id="exclusionBanner" class="exclusion-banner">
            <div class="exclusion-title">üö´ SASA TUNAONDOA VYAKULA HIVI:</div>
            <ul class="exclusion-list" id="exclusionList"></ul>
        </div>

        <!-- Testing Alert -->
        <div id="testingAlert" class="testing-alert">
            <h3>üìã LEO NI SIKU YA KUPIMA: <span id="testingFood"></span></h3>
            <div class="checklist">
                <div class="checklist-item">
                    <input type="checkbox" id="check1">
                    <label for="check1">Mtoto HAKULA <span class="food-name"></span> kwa siku 14</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="check2">
                    <label for="check2">Hakula vyakula vyenye <span class="food-name"></span> (biskuti, n.k.)</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="check3">
                    <label for="check3">Mtoto ana afya nzuri leo (hana homa/mafua)</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="check4">
                    <label for="check4">Nina dawa za mzio (antihistamine) ikiwa itahitajika</label>
                </div>
            </div>
            <div class="testing-buttons">
                <button class="btn-start-test" onclick="startTesting()">ANZA KUPIMA</button>
                <button class="btn-postpone" onclick="postponeTest()">Sio Leo - Ahirisha</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>üçº Ufuatiliaji wa Mzio wa Chakula</h1>
            
            <div class="child-selector">
                <label>Chagua Mtoto:</label>
                <select id="childSelect" onchange="loadChildData()">
                    <option value="">-- Chagua Mtoto --</option>
                </select>
                <button class="add-child-btn" onclick="showAddChildModal()">+ Ongeza Mtoto</button>
            </div>
            
            <div class="child-info" id="childInfo" style="display: none;">
                <span>üë∂ <strong id="childName"></strong></span>
                <span>üìÖ Umri: <strong id="childAge"></strong></span>
                <span id="dangerAlert" style="display: none;">
                    <span class="danger-tag">‚ö†Ô∏è KUNA MZIO HATARI</span>
                </span>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('diary')">üìù Kumbukumbu</button>
                <button class="tab" onclick="switchTab('testing')">üß™ Kupima</button>
                <button class="tab" onclick="switchTab('results')">üìä Matokeo</button>
                <button class="tab" onclick="switchTab('export')">üìÑ Ripoti</button>
            </div>

            <!-- Tab: Food Diary -->
            <div id="diary" class="tab-content active">
                <div class="section">
                    <h2>Rekodi Chakula cha Leo</h2>
                    
                    <div class="food-input-group">
                        <input type="text" class="food-input" id="foodInput" 
                               placeholder="Andika chakula (mfano: ugali, maharage, maziwa)">
                        <button class="add-food-btn" onclick="addFood()">+ Ongeza</button>
                    </div>

                    <div class="foods-list" id="todayFoods"></div>

                    <!-- Simplified reaction recording -->
                    <div style="margin-top: 30px; padding: 20px; background: #ffebee; border-radius: 10px;">
                        <h3 style="color: #c62828; margin-bottom: 15px;">Kulikuwa na Mzio?</h3>
                        <button class="btn-reaction btn-no-reaction" onclick="recordNoReaction()">
                            ‚úÖ HAKUNA MZIO LEO
                        </button>
                        <button class="btn-reaction btn-had-reaction" onclick="showReactionModal()">
                            ‚ö†Ô∏è KULIKUWA NA MZIO
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab: Testing Queue -->
            <div id="testing" class="tab-content">
                <div class="section">
                    <h2>üß™ Orodha ya Kupima</h2>
                    
                    <div class="queue-container" id="testingQueue">
                        <!-- Queue items will be added here -->
                    </div>

                    <button class="add-food-btn" onclick="showAddSuspectModal()">
                        + Ongeza Chakula cha Kushuku
                    </button>
                </div>
            </div>

            <!-- Tab: Results -->
            <div id="results" class="tab-content">
                <div class="section">
                    <h2>üìä Matokeo ya Kupima</h2>
                    
                    <div class="results-container" id="resultsContainer">
                        <!-- Results will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Export -->
            <div id="export" class="tab-content">
                <div class="section">
                    <h2>üìÑ Ripoti ya Daktari</h2>
                    
                    <button class="add-food-btn" onclick="generateReport()">
                        üì• Pakua Ripoti (PDF)
                    </button>
                    
                    <button class="add-food-btn" onclick="emailReport()" style="background: #1976d2;">
                        üìß Tuma kwa Email
                    </button>
                </div>
            </div>
        </div>

        <!-- No child selected message -->
        <div id="noChildMessage" class="section" style="display: none;">
            <p style="text-align: center; color: #666;">Tafadhali chagua mtoto kutoka hapo juu</p>
        </div>
    </div>

    <!-- Test Instructions Modal -->
    <div id="testModal" class="test-modal">
        <div class="test-modal-content">
            <h2>KUPIMA: <span id="testFoodName"></span></h2>
            
            <div class="test-steps">
                <div class="test-step">
                    <div class="test-step-time">‚è∞ SASA - Saa 8:00 asubuhi</div>
                    <p><strong>Hatua 1:</strong> Mpe kiasi KIDOGO SANA</p>
                    <ul>
                        <li>Kiasi: 1/8 ya kijiko cha chai au kidogo zaidi</li>
                        <li>Unaweza kuchanganya na chakula anachopenda</li>
                    </ul>
                </div>

                <div class="test-step">
                    <div class="test-step-time">‚è∞ Saa 8:00 - 10:00</div>
                    <p><strong>Hatua 2:</strong> Chunga kwa makini</p>
                    <ul>
                        <li>Upele au mabadiliko ya ngozi?</li>
                        <li>Kuvimba uso au midomo?</li>
                        <li>Kutapika au kuhara?</li>
                        <li>Shida ya kupumua?</li>
                    </ul>
                </div>

                <div class="test-step">
                    <div class="test-step-time">‚è∞ Saa 10:00</div>
                    <p><strong>Hatua 3:</strong> Ikiwa hamna mzio, ongeza kiasi</p>
                    <ul>
                        <li>Kiasi: 1/2 ya kijiko cha chai</li>
                    </ul>
                </div>

                <div class="test-step">
                    <div class="test-step-time">‚è∞ Saa 10:00 - 2:00 mchana</div>
                    <p><strong>Hatua 4:</strong> Endelea kuchunguza</p>
                </div>
            </div>

            <div class="reaction-buttons">
                <button class="btn-no-reaction" onclick="recordTestSuccess()">
                    HAKUNA MZIO - Salama!
                </button>
                <button class="btn-had-reaction" onclick="recordTestReaction()">
                    KULIKUWA NA MZIO!
                </button>
            </div>
        </div>
    </div>

    <script src="../js/core/database.js"></script>
    <script>
        // Global variables
        let currentChild = null;
        let testingQueue = [];
        let excludedFoods = [];
        let todaysFoods = [];
        let testingToday = null;

        // Initialize
        window.onload = function() {
            loadChildren();
            checkForTestingToday();
        };

        // Load children
        function loadChildren() {
            const data = window.familyDB.getData();
            const select = document.getElementById('childSelect');
            
            select.innerHTML = '<option value="">-- Chagua Mtoto --</option>';
            
            if (data.children && data.children.length > 0) {
                data.children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = child.name;
                    select.appendChild(option);
                });
            }
        }

        // Load child data
        function loadChildData() {
            const childId = document.getElementById('childSelect').value;
            
            if (!childId) {
                currentChild = null;
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('noChildMessage').style.display = 'block';
                return;
            }
            
            const data = window.familyDB.getData();
            currentChild = data.children.find(c => c.id === childId);
            
            if (currentChild) {
                document.getElementById('childName').textContent = currentChild.name;
                document.getElementById('childAge').textContent = calculateAge(currentChild.birthdate);
                
                // Check for dangerous reactions
                if (currentChild.dangerousFoods && currentChild.dangerousFoods.length > 0) {
                    document.getElementById('dangerAlert').style.display = 'inline';
                }
                
                document.getElementById('childInfo').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('noChildMessage').style.display = 'none';
                
                // Load testing queue
                loadTestingQueue();
                updateExclusionBanner();
                checkForTestingToday();
            }
        }

        // Calculate age
        function calculateAge(birthdate) {
            const birth = new Date(birthdate);
            const today = new Date();
            const months = (today.getFullYear() - birth.getFullYear()) * 12 + 
                          (today.getMonth() - birth.getMonth());
            
            if (months < 12) {
                return `Miezi ${months}`;
            } else {
                const years = Math.floor(months / 12);
                return `Miaka ${years}`;
            }
        }

        // Load testing queue
        function loadTestingQueue() {
            if (!currentChild) return;
            
            const data = window.familyDB.getData();
            const queue = data.testingQueues ? 
                         data.testingQueues.filter(q => q.childId === currentChild.id) : [];
            
            testingQueue = queue;
            displayTestingQueue();
            updateExclusionBanner();
        }

        // Display testing queue
        function displayTestingQueue() {
            const container = document.getElementById('testingQueue');
            container.innerHTML = '';
            
            if (testingQueue.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Hakuna vyakula vya kupima</p>';
                return;
            }
            
            testingQueue.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'queue-item';
                
                // Determine status
                if (item.status === 'testing') {
                    div.classList.add('testing');
                } else if (item.status === 'waiting') {
                    div.classList.add('waiting');
                } else {
                    div.classList.add('scheduled');
                }
                
                const testDate = new Date(item.testDate);
                const today = new Date();
                today.setHours(0,0,0,0);
                testDate.setHours(0,0,0,0);
                
                let statusText = '';
                if (item.status === 'testing') {
                    const daysLeft = 14 - Math.floor((today - new Date(item.startDate)) / (1000 * 60 * 60 * 24));
                    statusText = `Inaondolewa - Siku ${14 - daysLeft}/14`;
                } else if (testDate < today) {
                    statusText = `IMECHELEWA - Ilipaswa ${testDate.toLocaleDateString('sw-TZ')}`;
                } else if (testDate.getTime() === today.getTime()) {
                    statusText = `LEO - Pima!`;
                } else {
                    statusText = `Kupima: ${testDate.toLocaleDateString('sw-TZ')}`;
                }
                
                div.innerHTML = `
                    <div class="queue-info">
                        <div class="queue-food-name">${item.food}</div>
                        <div class="queue-status">${statusText}</div>
                        ${item.dangerousReaction ? '<span class="danger-tag">‚ö†Ô∏è Hospitalini tu!</span>' : ''}
                    </div>
                    <div class="queue-actions">
                        ${item.status === 'testing' && testDate <= today ? 
                          `<button class="queue-btn" onclick="promptTest('${item.id}')">Pima Sasa</button>` : ''}
                        <button class="queue-btn" onclick="removeFromQueue('${item.id}')">Ondoa</button>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // Update exclusion banner
        function updateExclusionBanner() {
            const banner = document.getElementById('exclusionBanner');
            const list = document.getElementById('exclusionList');
            
            excludedFoods = testingQueue.filter(item => 
                item.status === 'testing' || item.status === 'waiting'
            );
            
            if (excludedFoods.length === 0) {
                banner.classList.remove('active');
                return;
            }
            
            banner.classList.add('active');
            list.innerHTML = '';
            
            excludedFoods.forEach(item => {
                const li = document.createElement('li');
                li.className = 'exclusion-item';
                
                let statusText = '';
                if (item.status === 'testing') {
                    const today = new Date();
                    const testDate = new Date(item.testDate);
                    const daysLeft = Math.ceil((testDate - today) / (1000 * 60 * 60 * 24));
                    statusText = `<span class="status-testing">Inapimwa - siku ${daysLeft} zimebaki</span>`;
                } else {
                    statusText = `<span class="status-queue">Inasubiri kupimwa</span>`;
                }
                
                li.innerHTML = `‚Ä¢ ${item.food} - ${statusText}`;
                list.appendChild(li);
            });
            
            // Check for dangerous foods
            const hasDangerous = excludedFoods.some(f => f.dangerousReaction);
            if (hasDangerous) {
                banner.classList.add('danger');
                document.querySelector('.exclusion-title').textContent = 
                    '‚ö†Ô∏è ONYO: Kuna vyakula hatari - ondoa kabisa!';
            }
        }

        // Check if testing today
        function checkForTestingToday() {
            if (!currentChild || !testingQueue.length) return;
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const todayTest = testingQueue.find(item => {
                const testDate = new Date(item.testDate);
                testDate.setHours(0,0,0,0);
                return testDate.getTime() === today.getTime() && item.status === 'testing';
            });
            
            if (todayTest) {
                showTestingAlert(todayTest);
            }
        }

        // Show testing alert
        function showTestingAlert(testItem) {
            testingToday = testItem;
            const alert = document.getElementById('testingAlert');
            document.getElementById('testingFood').textContent = testItem.food.toUpperCase();
            document.querySelectorAll('.food-name').forEach(el => {
                el.textContent = testItem.food;
            });
            alert.classList.add('active');
        }

        // Start testing
        function startTesting() {
            // Check all checkboxes are checked
            const checks = document.querySelectorAll('.checklist input[type="checkbox"]');
            const allChecked = Array.from(checks).every(cb => cb.checked);
            
            if (!allChecked) {
                alert('Tafadhali thibitisha mambo yote kwanza!');
                return;
            }
            
            // Show test modal
            document.getElementById('testFoodName').textContent = testingToday.food.toUpperCase();
            document.getElementById('testModal').classList.add('show');
        }

        // Postpone test
        function postponeTest() {
            if (!testingToday) return;
            
            // Move test date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Update in database
            const data = window.familyDB.getData();
            const queueIndex = data.testingQueues.findIndex(q => q.id === testingToday.id);
            if (queueIndex !== -1) {
                data.testingQueues[queueIndex].testDate = tomorrow.toISOString();
                
                // Shift all subsequent tests
                for (let i = queueIndex + 1; i < data.testingQueues.length; i++) {
                    if (data.testingQueues[i].childId === currentChild.id) {
                        const currentDate = new Date(data.testingQueues[i].testDate);
                        currentDate.setDate(currentDate.getDate() + 1);
                        data.testingQueues[i].testDate = currentDate.toISOString();
                    }
                }
                
                window.familyDB.saveData(data);
            }
            
            // Hide alert
            document.getElementById('testingAlert').classList.remove('active');
            
            // Reload queue
            loadTestingQueue();
            
            alert('Kupima kumehairishwa mpaka kesho. Vyakula vingine vimesogezwa pia.');
        }

        // Record test success (no reaction)
        function recordTestSuccess() {
            if (!testingToday) return;
            
            // Move to safe foods
            const data = window.familyDB.getData();
            
            // Add to safe foods list
            if (!currentChild.safeFoods) currentChild.safeFoods = [];
            currentChild.safeFoods.push({
                food: testingToday.food,
                testedDate: new Date().toISOString(),
                notes: 'Hakuna mzio - salama'
            });
            
            // Remove from testing queue
            data.testingQueues = data.testingQueues.filter(q => q.id !== testingToday.id);
            
            // Update child data
            const childIndex = data.children.findIndex(c => c.id === currentChild.id);
            if (childIndex !== -1) {
                data.children[childIndex] = currentChild;
            }
            
            window.familyDB.saveData(data);
            
            // Close modal and refresh
            document.getElementById('testModal').classList.remove('show');
            document.getElementById('testingAlert').classList.remove('active');
            
            alert(`‚úÖ ${testingToday.food} ni SALAMA! Imehamishiwa kwenye orodha ya vyakula salama.`);
            
            loadTestingQueue();
            displayResults();
            
            // Start next food in queue if exists
            startNextInQueue();
        }

        // Record test reaction
        function recordTestReaction() {
            if (!testingToday) return;
            
            // Show reaction details modal (simplified for now)
            const severity = prompt('Mzio ulikuwa:\n1 - Nyepesi (upele kidogo)\n2 - Wastani (kutapika, kuhara)\n3 - Kali (kuvimba, kupumua kwa shida)\n\nAndika 1, 2 au 3:');
            
            const data = window.familyDB.getData();
            
            // Add to confirmed allergens
            if (!currentChild.confirmedAllergens) currentChild.confirmedAllergens = [];
            
            const allergen = {
                food: testingToday.food,
                confirmedDate: new Date().toISOString(),
                severity: severity === '3' ? 'severe' : severity === '2' ? 'moderate' : 'mild',
                nextRetry: null
            };
            
            // If severe, mark as dangerous
            if (severity === '3') {
                if (!currentChild.dangerousFoods) currentChild.dangerousFoods = [];
                currentChild.dangerousFoods.push({
                    food: testingToday.food,
                    reaction: 'Kuvimba/Kupumua kwa shida',
                    date: new Date().toISOString(),
                    note: 'JARIBU HOSPITALINI TU!'
                });
                allergen.nextRetry = 'Hospitalini tu baada ya miezi 6';
                
                // Set retry date 6 months later
                const retryDate = new Date();
                retryDate.setMonth(retryDate.getMonth() + 6);
                allergen.nextRetryDate = retryDate.toISOString();
            } else {
                // Set retry date 6 months later for regular allergens
                const retryDate = new Date();
                retryDate.setMonth(retryDate.getMonth() + 6);
                allergen.nextRetry = `Jaribu tena ${retryDate.toLocaleDateString('sw-TZ')}`;
                allergen.nextRetryDate = retryDate.toISOString();
            }
            
            currentChild.confirmedAllergens.push(allergen);
            
            // Remove from testing queue
            data.testingQueues = data.testingQueues.filter(q => q.id !== testingToday.id);
            
            // Update child data
            const childIndex = data.children.findIndex(c => c.id === currentChild.id);
            if (childIndex !== -1) {
                data.children[childIndex] = currentChild;
            }
            
            window.familyDB.saveData(data);
            
            // Close modal and refresh
            document.getElementById('testModal').classList.remove('show');
            document.getElementById('testingAlert').classList.remove('active');
            
            alert(`‚ö†Ô∏è ${testingToday.food} IMESABABISHA MZIO!\n\nItaondolewa kwa miezi 6.\nJaribu tena: ${allergen.nextRetry}`);
            
            loadTestingQueue();
            displayResults();
            
            // Start next food in queue
            startNextInQueue();
        }

        // Start next food in queue
        function startNextInQueue() {
            if (testingQueue.length === 0) return;
            
            // Find next waiting food
            const nextFood = testingQueue.find(q => q.status === 'waiting');
            
            if (nextFood) {
                const data = window.familyDB.getData();
                const queueIndex = data.testingQueues.findIndex(q => q.id === nextFood.id);
                
                if (queueIndex !== -1) {
                    // Start elimination period
                    const today = new Date();
                    const testDate = new Date();
                    testDate.setDate(testDate.getDate() + 14); // 14 days elimination
                    
                    data.testingQueues[queueIndex].status = 'testing';
                    data.testingQueues[queueIndex].startDate = today.toISOString();
                    data.testingQueues[queueIndex].testDate = testDate.toISOString();
                    
                    window.familyDB.saveData(data);
                    
                    alert(`Sasa tunaanza kuondoa ${nextFood.food} kwa siku 14.`);
                    
                    loadTestingQueue();
                }
            }
        }

        // Add food to diary
        function addFood() {
            const input = document.getElementById('foodInput');
            const foodName = input.value.trim();
            
            if (!foodName) return;
            
            // Check if food is in excluded list
            const isExcluded = excludedFoods.some(f => 
                f.food.toLowerCase() === foodName.toLowerCase()
            );
            
            if (isExcluded) {
                alert(`‚ö†Ô∏è ${foodName} ipo kwenye orodha ya vyakula tunavyoondoa sasa!\nTafadhali usimpe mtoto.`);
                input.value = '';
                return;
            }
            
            todaysFoods.push({
                name: foodName,
                time: new Date().toISOString()
            });
            
            input.value = '';
            renderFoods();
        }

        // Render foods
        function renderFoods() {
            const container = document.getElementById('todayFoods');
            container.innerHTML = '';
            
            if (todaysFoods.length === 0) {
                container.innerHTML = '<p style="color: #999;">Hakuna chakula kilichorekodiwa</p>';
                return;
            }
            
            todaysFoods.forEach((food, index) => {
                const tag = document.createElement('div');
                tag.className = 'food-tag';
                
                // Check if food is a known allergen
                if (currentChild && currentChild.confirmedAllergens) {
                    const isAllergen = currentChild.confirmedAllergens.some(a => 
                        a.food.toLowerCase() === food.name.toLowerCase()
                    );
                    if (isAllergen) {
                        tag.style.background = '#ffebee';
                        tag.style.color = '#c62828';
                    }
                }
                
                tag.innerHTML = `
                    ${food.name}
                    <button onclick="removeFood(${index})" style="background: none; border: none; cursor: pointer;">√ó</button>
                `;
                
                container.appendChild(tag);
            });
        }

        // Remove food
        function removeFood(index) {
            todaysFoods.splice(index, 1);
            renderFoods();
        }

        // Record no reaction for the day
        function recordNoReaction() {
            if (!currentChild || todaysFoods.length === 0) {
                alert('Tafadhali rekodi chakula kwanza!');
                return;
            }
            
            const entry = {
                childId: currentChild.id,
                date: new Date().toISOString(),
                foods: todaysFoods,
                hadReaction: false
            };
            
            window.familyDB.addFoodDiary(entry);
            
            alert('‚úÖ Imerekodiwa - Hakuna mzio leo!');
            todaysFoods = [];
            renderFoods();
        }

        // Show reaction modal
        function showReactionModal() {
            if (!currentChild || todaysFoods.length === 0) {
                alert('Tafadhali rekodi chakula kwanza!');
                return;
            }
            
            // Simplified for now - in real app would be a proper modal
            const reactionType = prompt('Aina ya mzio:\n1 - Upele/Kuwashwa\n2 - Kutapika/Kuhara\n3 - Kuvimba uso/midomo\n4 - Shida ya kupumua\n\nAndika namba:');
            
            const timeAfter = prompt('Muda baada ya kula:\n1 - Dakika 0-30\n2 - Dakika 30-60\n3 - Saa 1-2\n4 - Saa 2-4\n5 - Saa 4+\n\nAndika namba:');
            
            const entry = {
                childId: currentChild.id,
                date: new Date().toISOString(),
                foods: todaysFoods,
                hadReaction: true,
                reactionType: reactionType,
                timeAfterEating: timeAfter
            };
            
            window.familyDB.addFoodDiary(entry);
            
            // Analyze which foods might be suspicious
            analyzeSuspiciousFoods(entry);
            
            alert('‚ö†Ô∏è Mzio umerekodiwa. Tunachanganua vyakula vilivyoweza kusababisha...');
            
            todaysFoods = [];
            renderFoods();
        }

        // Analyze suspicious foods
        function analyzeSuspiciousFoods(reactionEntry) {
            // Get foods eaten in the time window
            let suspiciousFoods = [];
            
            // Based on reaction time, determine which meals to suspect
            const timeWindow = parseInt(reactionEntry.timeAfterEating);
            
            if (timeWindow <= 2) { // 0-60 minutes
                // Last 2 meals
                suspiciousFoods = reactionEntry.foods.slice(-8);
            } else if (timeWindow <= 4) { // 1-4 hours
                // All foods from today
                suspiciousFoods = reactionEntry.foods;
            } else { // 4+ hours
                // Could be anything from today or even yesterday
                suspiciousFoods = reactionEntry.foods;
            }
            
            // Add to testing queue if not already there
            const data = window.familyDB.getData();
            if (!data.testingQueues) data.testingQueues = [];
            
            suspiciousFoods.forEach(food => {
                // Check if already in queue
                const exists = data.testingQueues.some(q => 
                    q.childId === currentChild.id && 
                    q.food.toLowerCase() === food.name.toLowerCase()
                );
                
                if (!exists) {
                    const queueItem = {
                        id: 'queue_' + Date.now() + '_' + Math.random(),
                        childId: currentChild.id,
                        food: food.name,
                        status: data.testingQueues.length === 0 ? 'testing' : 'waiting',
                        addedDate: new Date().toISOString(),
                        dangerousReaction: parseInt(reactionEntry.reactionType) >= 3
                    };
                    
                    // If first item or only item, start testing immediately
                    if (queueItem.status === 'testing') {
                        const testDate = new Date();
                        testDate.setDate(testDate.getDate() + 14);
                        queueItem.startDate = new Date().toISOString();
                        queueItem.testDate = testDate.toISOString();
                    }
                    
                    data.testingQueues.push(queueItem);
                }
            });
            
            window.familyDB.saveData(data);
            loadTestingQueue();
        }

        // Display results
        function displayResults() {
            if (!currentChild) return;
            
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            
            // Safe foods
            if (currentChild.safeFoods && currentChild.safeFoods.length > 0) {
                const safeDiv = document.createElement('div');
                safeDiv.innerHTML = '<h3 style="color: #4caf50;">‚úÖ Vyakula Salama:</h3>';
                
                currentChild.safeFoods.forEach(food => {
                    const card = document.createElement('div');
                    card.className = 'result-card result-safe';
                    card.innerHTML = `
                        <strong>${food.food}</strong><br>
                        <small>Ilipimwa: ${new Date(food.testedDate).toLocaleDateString('sw-TZ')}</small>
                    `;
                    safeDiv.appendChild(card);
                });
                
                container.appendChild(safeDiv);
            }
            
            // Confirmed allergens
            if (currentChild.confirmedAllergens && currentChild.confirmedAllergens.length > 0) {
                const allergenDiv = document.createElement('div');
                allergenDiv.innerHTML = '<h3 style="color: #f44336; margin-top: 30px;">‚ö†Ô∏è Mzio Uliothibitishwa:</h3>';
                
                currentChild.confirmedAllergens.forEach(allergen => {
                    const card = document.createElement('div');
                    card.className = allergen.severity === 'severe' ? 'result-card result-dangerous' : 'result-card result-allergen';
                    card.innerHTML = `
                        <strong>${allergen.food}</strong><br>
                        <small>Ukali: ${allergen.severity}</small><br>
                        <small>${allergen.nextRetry}</small>
                    `;
                    allergenDiv.appendChild(card);
                });
                
                container.appendChild(allergenDiv);
            }
            
            if (!currentChild.safeFoods && !currentChild.confirmedAllergens) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Hakuna matokeo bado</p>';
            }
        }

        // Generate report
        function generateReport() {
            alert('Ripoti ya PDF inatengenezwa...\n(Hii ni demo - itakamilishwa baadaye)');
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'results') {
                displayResults();
            }
        }

        // Add child modal functions (simplified)
        function showAddChildModal() {
            const name = prompt('Jina la mtoto:');
            if (!name) return;
            
            const birthdate = prompt('Tarehe ya kuzaliwa (YYYY-MM-DD):');
            if (!birthdate) return;
            
            const child = {
                id: 'child_' + Date.now(),
                name: name,
                birthdate: birthdate,
                createdAt: new Date().toISOString()
            };
            
            const data = window.familyDB.getData();
            if (!data.children) data.children = [];
            data.children.push(child);
            window.familyDB.saveData(data);
            
            loadChildren();
            document.getElementById('childSelect').value = child.id;
            loadChildData();
        }

        // Add suspect food
        function showAddSuspectModal() {
            if (!currentChild) {
                alert('Tafadhali chagua mtoto kwanza!');
                return;
            }
            
            const foodName = prompt('Chakula unachoshuku:');
            if (!foodName) return;
            
            const severity = prompt('Je, ameshawahi kuwa na mzio mkali?\n1 - Hapana\n2 - Ndio, mzio wa kawaida\n3 - Ndio, alivimba/alishindwa kupumua\n\nAndika 1, 2 au 3:');
            
            const data = window.familyDB.getData();
            if (!data.testingQueues) data.testingQueues = [];
            
            // Check current testing queue for this child
            const childQueue = data.testingQueues.filter(q => q.childId === currentChild.id);
            
            const queueItem = {
                id: 'queue_' + Date.now(),
                childId: currentChild.id,
                food: foodName,
                status: childQueue.length === 0 ? 'testing' : 'waiting',
                addedDate: new Date().toISOString(),
                dangerousReaction: severity === '3'
            };
            
            if (queueItem.status === 'testing') {
                const testDate = new Date();
                testDate.setDate(testDate.getDate() + 14);
                queueItem.startDate = new Date().toISOString();
                queueItem.testDate = testDate.toISOString();
                alert(`Tunaanza kuondoa ${foodName} kwa siku 14.`);
            } else {
                alert(`${foodName} imeongezwa kwenye foleni ya kupima.`);
            }
            
            data.testingQueues.push(queueItem);
            window.familyDB.saveData(data);
            
            loadTestingQueue();
        }

        // Remove from queue
        function removeFromQueue(queueId) {
            if (!confirm('Una uhakika unataka kuondoa chakula hiki kutoka orodha ya kupima?')) {
                return;
            }
            
            const data = window.familyDB.getData();
            data.testingQueues = data.testingQueues.filter(q => q.id !== queueId);
            window.familyDB.saveData(data);
            
            loadTestingQueue();
        }

        // Prompt test for overdue item
        function promptTest(queueId) {
            const item = testingQueue.find(q => q.id === queueId);
            if (item) {
                showTestingAlert(item);
            }
        }
    </script>
</body>
</html>
